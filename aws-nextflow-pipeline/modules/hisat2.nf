/*
 * HISAT2 Alignment - Splice-aware RNA-Seq read alignment with sorting and QC
 * 
 * Performs alignment of paired-end sequencing reads to a reference genome using HISAT2.
 * Requires pre-built indices generated by prepare.nf workflow. Outputs sorted BAM files
 * for downstream quantification and flagstat metrics for quality assessment.
 * 
 * Input:
 * - tuple val(sample_id), path(read1), path(read2): Paired-end FASTQ files
 * - val index_dir: Directory containing pre-built HISAT2 genome index
 * 
 * Output:
 * - tuple val(sample_id), path("${sample_id}.bam"), emit: bam_files: Sorted BAM
 * - path "${sample_id}_HISAT2.log": Alignment execution log
 * - path "${sample_id}_flagstat.txt", emit: flagstat_files: Alignment metrics
 * 
 * Parameters:
 * - hisat2.threads: CPU threads (default: 3)
 * - hisat2.memory: Memory allocation (default: 8 GB)
 * - hisat2.rna_strandness: Strand specificity (default: "FR")
 * - hisat2.max_intronlen: Maximum intron length (default: 500000)
 * - hisat2.min_intronlen: Minimum intron length (default: 20)
 * 
 * Integration: Sorted BAM outputs for featureCounts, flagstat for MultiQC
 * Example: (bam_files_data, hisat2_logs, flagstat_files) = hisat2(trimmed_reads_data, index_dir_str)
 * 
 * Note: Run 'nextflow run prepare.nf' first to build required indices
 */

process hisat2 {

    label 'alignment'
    cpus params['hisat2.threads']
    memory params['hisat2.memory']

    publishDir "${params.results}/alignment", mode: 'copy', pattern: "*.bam*"
    publishDir "${params.results}/alignment", mode: 'copy', pattern: "*_flagstat.txt"

    input:
    tuple val(sample_id), path(read1), path(read2)
    path index_dir

    output:
    tuple val(sample_id), path("${sample_id}.bam"), emit: bam_files
    path "${sample_id}_HISAT2.log"
    path "${sample_id}_flagstat.txt", emit: flagstat_files

    script:
    """
    # Verify HISAT2 index exists
    if [ ! -e "${index_dir}/genome.1.ht2" ]; then
        echo "ERROR: HISAT2 index not found at ${index_dir}/genome.*.ht2"
        echo "Please run the preparation workflow first: nextflow run prepare.nf -profile ${workflow.profile}"
        echo "Example: nextflow run prepare.nf -profile aws"
        exit 1
    fi

    echo "Using pre-built HISAT2 index from: ${index_dir}"
    ls -la ${index_dir}/genome.*.ht2

    # Align reads (IMPORTANT: -S /dev/stdout)
    hisat2 \
        -p ${task.cpus} \
        -x ${index_dir}/genome \
        -1 ${read1} \
        -2 ${read2} \
        --dta \
        --rna-strandness ${params['hisat2.rna_strandness']} \
        -S /dev/stdout \
        2> ${sample_id}_HISAT2.log | \
    samtools sort -@ ${task.cpus} -o ${sample_id}.bam

    samtools index ${sample_id}.bam
    
    # Alignment verification
    samtools flagstat ${sample_id}.bam > ${sample_id}_flagstat.txt
    """
}
